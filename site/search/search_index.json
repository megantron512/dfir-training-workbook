{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to the Datadog Cloud DFIR Training!","text":"<p>In this week's training we will be learning how to investigate cloud-based incidents. Throughout the training you will have the opportunity to get hands-on experience by working through a series of labs. Some of these labs will be focused on individual techniques while some will present an end-to-end attack scenario.</p>"},{"location":"aws/aws_ransomware/","title":"Ransomware in AWS","text":""},{"location":"aws/aws_ransomware/#background","title":"Background","text":"<p>SIRT has received an alert about an external KMS key being used to encrypt resources. For the sake of this lab, no signal was generated, but if it had been, it would have been triggered by this GenerateDataKey event.    </p>"},{"location":"aws/aws_ransomware/#logs","title":"Logs","text":"<p>The logs for this lab fall within the following time frame: <code>&lt;tbd&gt;</code>. We can use the following filter to focus on the CloudTrail logs in the relevant AWS account: <code>source:cloudtrail account:711387092967</code></p> <p>Note</p> <p>Since the sandbox infrastructure was used for lab development, if you do not limit your searches to account ID <code>711387092967</code>, \"attacker\" activity will appear in the results. Feel free to look at the events to get familiar with different event types, but in the case of a similar incident, these events will not appear as they will be logged in attacker infrastructure.</p>"},{"location":"aws/aws_ransomware/#investigation","title":"Investigation","text":"<p>Start by reviewing the triggering event and understanding what is happening. </p> What is the attacker doing based on this event? Hint <ul> <li>Search Google or generate AI to understand the <code>GenerateDataKey</code> event.  </li> <li>Look at <code>@requestParameters</code> for more context.</li> </ul> Answer <p>This event indicates an attempt to encrypt data in AWS. The request parameters provide the following context:  </p> <ul> <li>The object that was encrypted is <code>arn:aws:s3:::financial-reports-2025-23943/company_secrets.txt</code>, a file named <code>company_secrets.txt</code> in an S3 bucket called <code>financial-reports-2025-23943</code>.   </li> <li>It was encryted with a KMS key with ARN <code>arn:aws:kms:us-east-1:601427279990:key/aba2894d-c354-499a-b55b-329a8e776c20</code>. </li> </ul> What is a notable attribute of the KMS key involved in the encryption? Hint <p>Review what each part of the ARN represents. Is there anything in the key's ARN that does not match with the context of this event?</p> Answer <p>The account ID shown in the ARN (<code>601427279990</code>) is from a different account than the one in which the encryption is occuring. In this particular case, due to testing infrastructure, it is another account within Datadog. The signal logic and what would likely be observed in an attack though is a key outside of Datadog being used. </p> <p>Now that we have reviewed the triggering event, let's look at the bigger picture and find out what other activity is associated with the attacker.</p> What indicators can help us track the relevant activity? Hint <p>Take note of the following properties:   </p> <ul> <li>@userIdentity.arn</li> <li>@resource.ARN</li> </ul> Answer <ul> <li>User ARN: <code>arn:aws:iam::711387092967:user/CloudOpsMonitor</code> </li> <li>KMS Key ARN: <code>arn:aws:kms:us-east-1:601427279990:key/aba2894d-c354-499a-b55b-329a8e776c20</code></li> </ul> <p>Before broadening our search to all activity from the IAM user, let's first see the full scope of the encryption activities.</p> How many files were encrypted? Gather a list of the files. Hint <p>Filter by the KMS key ARN: <code>index:cloudtrail account:711387092967 @resources.ARN:\"arn:aws:kms:us-east-1:601427279990:key/aba2894d-c354-499a-b55b-329a8e776c20\"</code>. Group by <code>@requestParameters.encryptionContext.aws:s3:arn</code> for a quick view of all encrypted resources.</p> Answer <p>10 files were encrypted, all in the <code>financial-reports-2025-23943</code> bucket. </p> <p></p> <p>We've mentioned in training that not all S3 buckets provide data-level logging, so any write or read operations on the bucket will not be logged. Let's go look at the bucket in the AWS console quick and see if there is anything notable.</p> Besides the bad practice of storing seemingly sensitive files, is there anything notable about the files in the bucket? Hint <p>Look at the most recently modified file.</p> Answer <p>After each file is overwritten with an encrypted version of the file (Last Modified timestamps are seconds apart), a <code>RANSOM_NOTE.txt</code> is modified or created. Viewing this file reveals a ransom note that says an AWS KMS key was used to encrypt the other files and that if payment isn't made, the encryption key will be deleted after 7 days.</p> <p>At this point, we've figured out that we were the target of a ransomware attack where an external KMS key was used to encrypt all the files in our bucket. To better understand the sequence of events that led to this, let's broaden our search to include all activity by the <code>CloudOpsMonitor</code> IAM user.</p>"},{"location":"aws/lab1/","title":"Lab 1: AWS Authentication at Datadog","text":"<p>This lab is to begin understanding what authentication looks like in the logs when users accesss AWS using SSO. </p> <p>Before walking through the questions below, navigate to the AWS access portal and search for the <code>datadog-dfir-training-2025</code> account. Access it using the <code>security-admin</code> role. Within a few minutes, associated logs should be generated and shipped to the Datadog.</p>"},{"location":"aws/lab1/#goal","title":"Goal","text":"<p>The primary goal of this lab is to identify all event types that are generated when a Datadog user signs in with SSO. The upcoming slides in the training will go into detail about these events, but see what you can find yourself before we cover any gaps! </p> <p>If you think you've identified all relevant log entries, as a bonus challenge, identify other types of authentication that are occuring and notable properties associated with those events that could assist in investigating malicious activity. </p>"},{"location":"gcp/service_account_abuse/","title":"Default Service Account Abuse in Google Cloud","text":""},{"location":"gcp/service_account_abuse/#background","title":"Background","text":"<p>SIRT has received a Google Cloud Instance Creation via gcloud signal that has been determined to be suspicious/malicious. Investigate the signal and determine how the threat actor accessed the environment and what they did with their access.</p>"},{"location":"gcp/service_account_abuse/#logs","title":"Logs","text":"<p>The logs for this lab fall within the following time frame: <code>&lt;tbd&gt;</code>. We can use the following filter to focus on the CloudTrail logs in the relevant AWS account: <code>source:gcp* project_id:datadog-dfir-training-2025</code> </p> <p>Don't forget that there are some logs that don't make it to Datadog that might be worth exploring within Google Cloud Console.</p>"},{"location":"gcp/service_account_abuse/#investigation","title":"Investigation","text":"<p>Start by reviewing the signal and identifying noteworthy properties that might act as pivot points to discover related activity. </p> What indicators can help us track the relevant activity? Hint <p>Take note of the following properties:   </p> <ul> <li>IP address  </li> <li>User ID   </li> <li>Entities (related resources)  </li> </ul> Answer <ul> <li>IP address: <code>1.1.1.1</code></li> <li>User ID: <code>research-512-serivce-account@datadog-dfir-training-2025.iam.gserviceaccount.com</code></li> <li>Related resources:   <ul> <li>GCE INSTANCE 1</li> <li>GCE INSTANCE 2</li> <li>GCE INSTANCE 3</li> </ul> </li> </ul> <p>A good starting point is to understand the nature of the activity is to identify what the service account was used for.</p> What actions did the service account associated with the signal take? Hint <p>Look at the event names associated with activity where the user ID is <code>research-512-serivce-account@datadog-dfir-training-2025.iam.gserviceaccount.com</code>. You can either do this with grouping by fields in Log Explorer or using Investigator against the service account. </p> Answer <p>There are 6 different event types associated with this account:   </p> <ul> <li><code>v1 compute.instances.insert</code> </li> <li><code>iam.serviceAccounts.actAs</code></li> <li><code>v1.compute.instances.get</code></li> <li><code>v1.compute.projects.get</code></li> <li><code>v1.compute.zoneOperations.wait</code> </li> <li><code>v1.compute.zones.get</code> </li> </ul> <p>Most of the associated events are read-only activity, so let's focus on the first event type: <code>v1 compute.instances.insert</code>. This indicates attempts to deploy virtual machines on Google Cloud Compute.</p> How many virtual machines were deployed and hat are their instance names/IDs? Hint <p>Further filter the search for the project and service account using <code>@evt.name:v1 compute.instances.insert</code>. Look at <code>@data.protoPayload.resourceName</code> and <code>@data.resource.labels.instance_id</code> for the resource names and instance IDs.</p> Answer <ul> <li><code>instance-1</code> (ID ) <li><code>instance-2</code> (ID ) <li><code>instance-3</code> (ID ) <p>The logs don't provide full context. Let's look directly in Google Cloud at the virtual machines to see if there is anything interesting about the hosts that might point to attacker intent.</p> What interesting instance details could point to attacker intent? Hint <p>Look at the <code>Machine configuration</code> and <code>Custom metadata</code>.</p> Answer <p>There's two key details of interest here:  </p> <ol> <li>The host has GPUs attached. Attackers often create GPU-enabled VMs for the purpose of cryptomining.</li> <li>There is a <code>startup-script</code> key with a bash script that downloads a file from a remote host and executes it.</li> </ol> <p>Now we've determined that the threat actor's intention was likely to leverage our compute infrastructure for cryptomining or another malicious activity, we should work backwards to determine how this service account was compromised in the first place. </p> How did the threat actor authenticate the service account? Hint <p>Look at <code>@data.protoPayload.authenticationInfo</code> in any of the logs associated with the account's activity.</p> Answer <p>The authenticationInfo field shows that there is an associated <code>serviceAccountKeyName</code>, indicating a key exists for the service account and was used to authenticate the user of the account.</p> What is the scope of access that this account has? Hint <p>Use Policy Analyzed in Google Cloud to understand the service account's permissions. </p> Answer <p>The service account has an Editor role grant on the project <code>Datadog Dfir Training 2025</code>.</p> <p>It appears the threat actor has gotten a copy of a service account key in order to leverage the account's editor permissions to carry out their attack. Now we need to determine how the threat actor obtained access to the key. We have the source IP of the service account activity, so let's see if there is any other anomalous activity tied to that IP address.</p>"}]}